{% extends 'base.html' %}

{% block title %}Doctor Dashboard - Telemedicine Platform{% endblock %}

{% block content %}
<div class="dashboard-container">
    <h1>Welcome, Dr. {{ user.get_full_name|default:user.username }}</h1>
    
    <div class="feature-links">
        <a href="{% url 'manage_schedule' %}" class="feature-link">
            <i class="fas fa-calendar"></i>
            <span>Manage Schedule</span>
        </a>
        <a href="{% url 'patient_records' %}" class="feature-link">
            <i class="fas fa-file-medical"></i>
            <span>Patient Records</span>
        </a>
        <a href="{% url 'appointments' %}" class="feature-link">
            <i class="fas fa-video"></i>
            <span>Video Meetings</span>
        </a>
    </div>

    <div class="dashboard-grid">
        <div class="dashboard-card">
            <h2>Upcoming Appointments</h2>
            {% if appointments %}
                <div class="appointment-list">
                    {% for appointment in appointments %}
                        <div class="appointment-item">
                            <div class="appointment-header">
                                <h3>{{ appointment.patient.user.get_full_name|default:appointment.patient.user.username }}</h3>
                                <span class="status {{ appointment.status }}">{{ appointment.status|title }}</span>
                            </div>
                            <p><strong>Date:</strong> {{ appointment.date }}</p>
                            <p><strong>Time:</strong> {{ appointment.time }}</p>
                            <p><strong>Symptoms:</strong> {{ appointment.symptoms|truncatewords:20 }}</p>
                            {% if appointment.status == 'confirmed' %}
                                {% if appointment.meeting_link %}
                                    <a href="{{ appointment.meeting_link }}" class="btn btn-primary" target="_blank">Join Meeting</a>
                                {% else %}
                                    <button class="btn" onclick="startMeeting('{{ appointment.id }}')">Start Meeting</button>
                                {% endif %}
                            {% elif appointment.status == 'pending' %}
                                <div class="appointment-actions">
                                    <button class="btn btn-success" onclick="updateAppointmentStatus('{{ appointment.id }}', 'confirmed')">Accept</button>
                                    <button class="btn btn-danger" onclick="updateAppointmentStatus('{{ appointment.id }}', 'cancelled')">Decline</button>
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p>No upcoming appointments.</p>
            {% endif %}
        </div>

        <div class="dashboard-card">
            <h2>Your Schedule</h2>
            <div id="calendar">
                <!-- Calendar will be loaded here -->
            </div>
            <button class="btn" onclick="updateAvailability()">Update Availability</button>
        </div>

        <div class="dashboard-card">
            <h2>Patient Records</h2>
            <div class="patient-search">
                <input type="text" id="patient-search" placeholder="Search patients...">
                <button class="btn" onclick="searchPatients()">Search</button>
            </div>
            <div id="patient-records">
                <!-- Patient records will be loaded here -->
            </div>
        </div>

        <div class="dashboard-card">
            <h2>Prescriptions</h2>
            <div class="prescription-list">
                <!-- Recent prescriptions will be loaded here -->
            </div>
            <button class="btn" onclick="createPrescription()">Create New Prescription</button>
        </div>
    </div>
</div>

{% block extra_css %}
<style>
.dashboard-container {
    padding: 2rem;
}

.feature-links {
    display: flex;
    gap: 2rem;
    margin-bottom: 2rem;
    justify-content: center;
}

.feature-link {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 1.5rem;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    text-decoration: none;
    color: #333;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.feature-link:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.feature-link i {
    font-size: 2rem;
    margin-bottom: 0.5rem;
    color: #3b82f6;
}

.feature-link span {
    font-weight: 500;
}

.dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 2rem;
    margin-top: 2rem;
}

.dashboard-card {
    background: white;
    border-radius: 8px;
    padding: 1.5rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.appointment-item {
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 1rem;
    margin-bottom: 1rem;
}

.appointment-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.appointment-actions {
    display: flex;
    gap: 0.5rem;
    margin-top: 1rem;
}

.status {
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.875rem;
}

.status.pending {
    background-color: #fef3c7;
    color: #92400e;
}

.status.confirmed {
    background-color: #d1fae5;
    color: #065f46;
}

.status.cancelled {
    background-color: #fee2e2;
    color: #991b1b;
}

.status.completed {
    background-color: #e0e7ff;
    color: #3730a3;
}

.btn-success {
    background-color: #10b981;
}

.btn-success:hover {
    background-color: #059669;
}

.btn-danger {
    background-color: #ef4444;
}

.btn-danger:hover {
    background-color: #dc2626;
}

#patient-search {
    width: 100%;
    padding: 0.5rem;
    margin-bottom: 1rem;
    border: 1px solid #ddd;
    border-radius: 4px;
}

#calendar {
    min-height: 300px;
    border: 1px solid #ddd;
    border-radius: 4px;
    margin-bottom: 1rem;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
function updateAppointmentStatus(appointmentId, status) {
    fetch(`/api/appointments/${appointmentId}/status/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ status: status })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.error || 'Failed to update appointment status');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to update appointment status');
    });
}

function startMeeting(appointmentId) {
    // Implement video meeting functionality
}

function updateAvailability() {
    const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
    const availableTimes = {};
    
    days.forEach(day => {
        const daySchedule = prompt(`Enter available times for ${day} (format: 09:00-17:00, or 'off' for no availability):`);
        if (daySchedule && daySchedule.toLowerCase() !== 'off') {
            availableTimes[day] = daySchedule;
        }
    });
    
    fetch('/api/doctor/schedule/update/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ available_times: availableTimes })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Schedule updated successfully');
            loadCalendar();
        } else {
            alert(data.error || 'Failed to update schedule');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to update schedule');
    });
}

function searchPatients() {
    const query = document.getElementById('patient-search').value;
    
    fetch('/api/patients/records/')
        .then(response => response.json())
        .then(data => {
            const recordsDiv = document.getElementById('patient-records');
            if (!Array.isArray(data)) {
                recordsDiv.innerHTML = '<p>No patients found</p>';
                return;
            }
            
            recordsDiv.innerHTML = data.map(patient => `
                <div class="patient-card" onclick="showPatientDetails('${patient.id}')">
                    <h4>${patient.user.first_name} ${patient.user.last_name}</h4>
                    <p>DOB: ${patient.date_of_birth || 'Not provided'}</p>
                    <p>Blood Group: ${patient.blood_group || 'Not provided'}</p>
                </div>
            `).join('');
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to search patients');
        });
}

function showPatientDetails(patientId) {
    fetch(`/api/patients/records/?patient_id=${patientId}`)
        .then(response => response.json())
        .then(data => {
            const recordsDiv = document.getElementById('patient-records');
            recordsDiv.innerHTML = `
                <div class="patient-details">
                    <h3>${data.patient.user.first_name} ${data.patient.user.last_name}</h3>
                    <p><strong>DOB:</strong> ${data.patient.date_of_birth || 'Not provided'}</p>
                    <p><strong>Blood Group:</strong> ${data.patient.blood_group || 'Not provided'}</p>
                    <p><strong>Emergency Contact:</strong> ${data.patient.emergency_contact || 'Not provided'}</p>
                    
                    <h4>Health Records</h4>
                    ${data.health_records.length ? `
                        <div class="health-records-list">
                            ${data.health_records.map(record => `
                                <div class="record-item">
                                    <p><strong>${record.record_type}</strong> - ${record.date}</p>
                                    <p>${record.description}</p>
                                    <a href="${record.file}" target="_blank">View Record</a>
                                </div>
                            `).join('')}
                        </div>
                    ` : '<p>No health records available</p>'}
                    
                    <h4>Past Appointments</h4>
                    ${data.appointments.length ? `
                        <div class="appointments-list">
                            ${data.appointments.map(apt => `
                                <div class="appointment-item">
                                    <p><strong>Date:</strong> ${apt.date} ${apt.time}</p>
                                    <p><strong>Status:</strong> ${apt.status}</p>
                                    ${apt.diagnosis ? `<p><strong>Diagnosis:</strong> ${apt.diagnosis}</p>` : ''}
                                    ${apt.prescription ? `<p><strong>Prescription:</strong> ${apt.prescription}</p>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    ` : '<p>No past appointments</p>'}
                </div>
            `;
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to load patient details');
        });
}

function createPrescription() {
    const appointmentId = prompt('Enter Appointment ID:');
    if (!appointmentId) return;
    
    const diagnosis = prompt('Enter Diagnosis:');
    const prescription = prompt('Enter Prescription:');
    if (!prescription) {
        alert('Prescription is required');
        return;
    }
    
    fetch('/api/prescriptions/create/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            appointment_id: appointmentId,
            diagnosis: diagnosis,
            prescription: prescription
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Prescription created successfully');
            location.reload();
        } else {
            alert(data.error || 'Failed to create prescription');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to create prescription');
    });
}

// Load the calendar on page load
document.addEventListener('DOMContentLoaded', function() {
    loadCalendar();
    searchPatients();
});

function loadCalendar() {
    const calendar = document.getElementById('calendar');
    calendar.innerHTML = '<p>Loading schedule...</p>';
    
    fetch('/api/doctor/schedule/')
        .then(response => response.json())
        .then(data => {
            if (data.available_times) {
                calendar.innerHTML = `
                    <div class="schedule-grid">
                        ${Object.entries(data.available_times).map(([day, times]) => `
                            <div class="schedule-day">
                                <h4>${day.charAt(0).toUpperCase() + day.slice(1)}</h4>
                                <p>${times}</p>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else {
                calendar.innerHTML = '<p>No schedule set. Click "Update Availability" to set your schedule.</p>';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            calendar.innerHTML = '<p>Failed to load schedule</p>';
        });
}

// Get CSRF token from cookies
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Initialize calendar on page load
document.addEventListener('DOMContentLoaded', function() {
    // Implement calendar initialization
});
</script>
{% endblock %}
{% endblock %}
